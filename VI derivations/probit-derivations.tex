\documentclass[10pt]{article}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{latexsym} 
\usepackage{color}
%\usepackage{epsfig}
\usepackage{graphicx}
%\usepackage[dvips]{graphicx}


\usepackage[matrix,tips,graph,curve]{xy}

%\newcommand{\mnote}[1]{${}^*$\marginpar{\footnotesize ${}^*$#1}}
%\linespread{1.065}
%
%\makeatletter
%
%\setlength\@tempdima  {5.5in}
%\addtolength\@tempdima {-\textwidth}
%\addtolength\hoffset{-0.5\@tempdima}
%\setlength{\textwidth}{5.5in}
%\setlength{\textheight}{8.75in}
%\addtolength\voffset{-0.625in}
%
%\makeatother

\makeatletter 
\@addtoreset{equation}{section}
\makeatother

\setlength{\parindent}{0pt}

\renewcommand{\theequation}{\thesection.\arabic{equation}}

\usepackage[margin=0.5in]{geometry}

\theoremstyle{plain}
\newtheorem{theorem}[equation]{Theorem}
\newtheorem{corollary}[equation]{Corollary}
\newtheorem{lemma}[equation]{Lemma}
\newtheorem{proposition}[equation]{Proposition}
\newtheorem{conjecture}[equation]{Conjecture}
\newtheorem{fact}[equation]{Fact}
\newtheorem{facts}[equation]{Facts}
\newtheorem*{theoremA}{Theorem A}
\newtheorem*{theoremB}{Theorem B}
\newtheorem*{theoremC}{Theorem C}
\newtheorem*{theoremD}{Theorem D}
\newtheorem*{theoremE}{Theorem E}
\newtheorem*{theoremF}{Theorem F}
\newtheorem*{theoremG}{Theorem G}
\newtheorem*{theoremH}{Theorem H}

\theoremstyle{definition}
\newtheorem{definition}[equation]{Definition}
\newtheorem{definitions}[equation]{Definitions}
%\theoremstyle{remark}

\newtheorem{remark}[equation]{Remark}
\newtheorem{remarks}[equation]{Remarks}
\newtheorem{exercise}[equation]{Exercise}
\newtheorem{example}[equation]{Example}
\newtheorem{examples}[equation]{Examples}
\newtheorem{notation}[equation]{Notation}
\newtheorem{question}[equation]{Question}
\newtheorem{assumption}[equation]{Assumption}
\newtheorem*{claim}{Claim}
\newtheorem{answer}[equation]{Answer}
%%%%%% letters %%%%

\newcommand{\fA}{\mathfrak{A}}
\newcommand{\fB}{\mathfrak{B}}
\newcommand{\fC}{\mathfrak{C}}
\newcommand{\fD}{\mathfrak{D}}
\newcommand{\fE}{\mathfrak{E}}
\newcommand{\fF}{\mathfrak{F}}
\newcommand{\fG}{\mathfrak{G}}
\newcommand{\fH}{\mathfrak{H}}
\newcommand{\fI}{\mathfrak{I}}
\newcommand{\fJ}{\mathfrak{J}}
\newcommand{\fK}{\mathfrak{K}}
\newcommand{\fL}{\mathfrak{L}}
\newcommand{\fM}{\mathfrak{M}}
\newcommand{\fN}{\mathfrak{N}}
\newcommand{\fO}{\mathfrak{O}}
\newcommand{\fP}{\mathfrak{P}}
\newcommand{\fQ}{\mathfrak{Q}}
\newcommand{\fR}{\mathfrak{R}}
\newcommand{\fS}{\mathfrak{S}}
\newcommand{\fT}{\mathfrak{T}}
\newcommand{\fU}{\mathfrak{U}}
\newcommand{\fV}{\mathfrak{V}}
\newcommand{\fW}{\mathfrak{W}}
\newcommand{\fX}{\mathfrak{X}}
\newcommand{\fY}{\mathfrak{Y}}
\newcommand{\fZ}{\mathfrak{Z}}

\newcommand{\fa}{\mathfrak{a}}
\newcommand{\fb}{\mathfrak{b}}
\newcommand{\fc}{\mathfrak{c}}
\newcommand{\fd}{\mathfrak{d}}
\newcommand{\fe}{\mathfrak{e}}
\newcommand{\ff}{\mathfrak{f}}
\newcommand{\fg}{\mathfrak{g}}
\newcommand{\fh}{\mathfrak{h}}
%\newcommand{\fi}{\mathfrak{i}}

\newcommand{\fj}{\mathfrak{j}}
\newcommand{\fk}{\mathfrak{k}}
\newcommand{\fl}{\mathfrak{l}}
\newcommand{\fm}{\mathfrak{m}}
\newcommand{\fn}{\mathfrak{n}}
\newcommand{\fo}{\mathfrak{o}}
\newcommand{\fp}{\mathfrak{p}}
\newcommand{\fq}{\mathfrak{q}}
\newcommand{\fr}{\mathfrak{r}}
\newcommand{\fs}{\mathfrak{s}}
\newcommand{\ft}{\mathfrak{t}}
\newcommand{\fu}{\mathfrak{u}}
\newcommand{\fv}{\mathfrak{v}}
\newcommand{\fw}{\mathfrak{w}}
\newcommand{\fx}{\mathfrak{x}}
\newcommand{\fy}{\mathfrak{y}}
\newcommand{\fz}{\mathfrak{z}}


\newcommand{\sA}{\mathcal{A}\,}
\newcommand{\sB}{\mathcal{B}\,}
\newcommand{\sC}{\mathcal{C}}
\newcommand{\sD}{\mathcal{D}\,}
\newcommand{\sE}{\mathcal{E}\,}
\newcommand{\sF}{\mathcal{F}\,}
\newcommand{\sG}{\mathcal{G}\,}
\newcommand{\sH}{\mathcal{H}}
\newcommand{\sI}{\mathcal{I}\,}
\newcommand{\sJ}{\mathcal{J}\,}
\newcommand{\sK}{\mathcal{K}\,}
\newcommand{\sL}{\mathcal{L}\,}
\newcommand{\sM}{\mathcal{M}\,}
\newcommand{\sN}{\mathcal{N}}
\newcommand{\sO}{\mathcal{O}}
\newcommand{\sP}{\mathcal{P}\,}
\newcommand{\sQ}{\mathcal{Q}\,}
\newcommand{\sR}{\mathcal{R}}
\newcommand{\sS}{\mathcal{S}}
\newcommand{\sT}{\mathcal{T}\,}
\newcommand{\sU}{\mathcal{U}\,}
\newcommand{\sV}{\mathcal{V}\,}
\newcommand{\sW}{\mathcal{W}\,}
\newcommand{\sX}{\mathcal{X}\,}
\newcommand{\sY}{\mathcal{Y}\,}
\newcommand{\sZ}{\mathcal{Z}\,}

\newcommand{\IA}{\mathbb{A}}
\newcommand{\IB}{\mathbb{B}}
\newcommand{\IC}{\mathbb{C}}
\newcommand{\ID}{\mathbb{D}}
\newcommand{\IE}{\mathbb{E}}
\newcommand{\IF}{\mathbb{F}}
\newcommand{\IG}{\mathbb{G}}
\newcommand{\IH}{\mathbb{H}}
\newcommand{\II}{\mathbb{I}}
\newcommand{\IK}{\mathbb{K}}
\newcommand{\IL}{\mathbb{L}}
\newcommand{\IM}{\mathbb{M}}
\newcommand{\IN}{\mathbb{N}}
\newcommand{\IO}{\mathbb{O}}
\newcommand{\IP}{\mathbb{P}}
\newcommand{\IQ}{\mathbb{Q}}
\newcommand{\IR}{\mathbb{R}}
\newcommand{\IS}{\mathbb{S}}
\newcommand{\IT}{\mathbb{T}}
\newcommand{\IU}{\mathbb{U}}
\newcommand{\IV}{\mathbb{V}}
\newcommand{\IW}{\mathbb{W}}
\newcommand{\IX}{\mathbb{X}}
\newcommand{\IY}{\mathbb{Y}}
\newcommand{\IZ}{\mathbb{Z}}


 \newcommand{\tA}{\mathrm {A}}
 \newcommand{\tB}{\mathrm {B}}
 \newcommand{\tC}{\mathrm {C}}
 \newcommand{\tD}{\mathrm {D}}
 \newcommand{\tE}{\mathrm {E}}
 \newcommand{\tF}{\mathrm {F}}
 \newcommand{\tG}{\mathrm {G}}
 \newcommand{\tH}{\mathrm {H}}
 \newcommand{\tI}{\mathrm {I}}
 \newcommand{\tJ}{\mathrm {J}}
 \newcommand{\tK}{\mathrm {K}}
 \newcommand{\tL}{\mathrm {L}}
 \newcommand{\tM}{\mathrm {M}}
 \newcommand{\tN}{\mathrm {N}}
 \newcommand{\tO}{\mathrm {O}}
 \newcommand{\tP}{\mathrm {P}}
 \newcommand{\tQ}{\mathrm {Q}}
 \newcommand{\tR}{\mathrm {R}}
 \newcommand{\tS}{\mathrm {S}}
 \newcommand{\tT}{\mathrm {T}}
 \newcommand{\tU}{\mathrm {U}}
 \newcommand{\tV}{\mathrm {V}}
 \newcommand{\tW}{\mathrm {W}}
 \newcommand{\tX}{\mathrm {X}}
 \newcommand{\tY}{\mathrm {Y}}
 \newcommand{\tZ}{\mathrm {Z}}
%%%%%%% macros %%%%%

%% my definitions %%%

\newcommand{\End}{\mathrm{End}}
\newcommand{\tr}{\mathrm{tr}}
%\newcommand{\ind}{\mathrm{ind}}

\renewcommand{\index}{\mathrm{index \,}}
\newcommand{\Hom}{\mathrm{Hom}}
\newcommand{\Aut}{\mathrm{Aut}}
\newcommand{\Trace}{\mathrm{Trace}\,}
\newcommand{\Res}{\mathrm{Res}\,}
\newcommand{\rank}{\mathrm{rank}}
%\renewcommand{\dim}{\mathrm{dim}}

\renewcommand{\deg}{\mathrm{deg}}
\newcommand{\spin}{\rm Spin}
\newcommand{\Spin}{\rm Spin}
\newcommand{\erfc}{\rm erfc\,}
\newcommand{\sgn}{\rm sgn\,}
\newcommand{\Spec}{\rm Spec\,}
\newcommand{\diag}{\rm diag\,}
\newcommand{\Fix}{\mathrm{Fix}}
\newcommand{\Ker}{\mathrm{Ker \,}}
\newcommand{\Coker}{\mathrm{Coker \,}}
\newcommand{\Sym}{\mathrm{Sym \,}}
\newcommand{\Hess}{\mathrm{Hess \,}}
\newcommand{\grad}{\mathrm{grad \,}}
\newcommand{\Center}{\mathrm{Center}}
\newcommand{\Lie}{\mathrm{Lie}}


\newcommand{\ch}{\rm ch} % Chern Character

\newcommand{\rk}{\rm rk} 
%\renewcommand{\c}{\rm c}  % Chern class

\newcommand{\sign}{\rm sign}
\renewcommand\dim{{\rm dim\,}}
\renewcommand\det{{\rm det\,}}
\newcommand{\dimKrull}{{\rm Krulldim\,}}
\newcommand\Rep{\mathrm{Rep}}
\newcommand\Hilb{\mathrm{Hilb}}
\newcommand\vol{\mathrm{vol}}

\newcommand\QED{\hfill $\Box$} %{\bf QED}} 

\newcommand\Pf{\nonintend{\em Proof. }}


\newcommand\reals{{\mathbb R}} 
\newcommand\complexes{{\mathbb C}}
\renewcommand\i{\sqrt{-1}}
\renewcommand\Re{\mathrm Re}
\renewcommand\Im{\mathrm Im}
\newcommand\integers{{\mathbb Z}}
\newcommand\quaternions{{\mathbb H}}


\newcommand\iso{{\cong}} 
\newcommand\tensor{{\otimes}}
\newcommand\Tensor{{\bigotimes}} 
\newcommand\union{\bigcup} 
\newcommand\onehalf{\frac{1}{2}}
%\newcommand\Sym[1]{{Sym^{#1}(\complexes^2)}}

\newcommand\lie[1]{{\mathfrak #1}} 
\renewcommand\fk{\mathfrak{K}}
\newcommand\smooth{\mathcal{C}^{\infty}}
\newcommand\trivial{{\mathbb I}}
\newcommand\widebar{\overline}

%%%%%Delimiters%%%%

\newcommand{\<}{\langle}
\renewcommand{\>}{\rangle}

%\renewcommand{\(}{\left(}
%\renewcommand{\)}{\right)}


%%%% Different kind of derivatives %%%%%

\newcommand{\delbar}{\bar{\partial}}
\newcommand{\pdu}{\frac{\partial}{\partial u}}
%\newcommand{\pd}[1][2]{\frac{\partial #1}{\partial #2}}

%%%%% Arrows %%%%%
%\renewcommand{\ra}{\rightarrow}                   % right arrow
%\newcommand{\lra}{\longrightarrow}              % long right arrow
%\renewcommand{\la}{\leftarrow}                    % left arrow
%\newcommand{\lla}{\longleftarrow}               % long left arrow
%\newcommand{\ua}{\uparrow}                     % long up arrow
%\newcommand{\na}{\nearrow}                      %  NE arrow
%\newcommand{\llra}[1]{\stackrel{#1}{\lra}}      % labeled long right arrow
%\newcommand{\llla}[1]{\stackrel{#1}{\lla}}      % labeled long left arrow
%\newcommand{\lua}[1]{\stackrel{#1}{\ua}}      % labeled  up arrow
%\newcommand{\lna}[1]{\stackrel{#1}{\na}}      % labeled long NE arrow

\newcommand{\into}{\hookrightarrow}
\newcommand{\tto}{\longmapsto}
\def\llra{\longleftrightarrow}

\def\d/{/\mspace{-6.0mu}/}
\newcommand{\git}[3]{#1\d/_{\mspace{-4.0mu}#2}#3}
\newcommand\zetahilb{\zeta_{{\text{Hilb}}}}
\def\Fy{\sF \mspace{-3.0mu} \cdot \mspace{-3.0mu} y}
\def\tv{\tilde{v}}
\def\tw{\tilde{w}}
\def\wt{\widetilde}
\def\wtilde{\widetilde}
\def\what{\widehat}

%%%%%%%%%%%%%%%%%%% Mark's definitions %%%%%%%%%%%%%%%%%%%%

\newcommand{\frakg}{\mbox{\frakturfont g}}
\newcommand{\frakk}{\mbox{\frakturfont k}}
\newcommand{\frakp}{\mbox{\frakturfont p}}
\newcommand{\q}{\mbox{\frakturfont q}}
\newcommand{\frakn}{\mbox{\frakturfont n}}
\newcommand{\frakv}{\mbox{\frakturfont v}}
\newcommand{\fraku}{\mbox{\frakturfont u}}
\newcommand{\frakh}{\mbox{\frakturfont h}}
\newcommand{\frakm}{\mbox{\frakturfont m}}
\newcommand{\frakt}{\mbox{\frakturfont t}}
\newcommand{\G}{\Gamma}
\newcommand{\g}{\gamma}
\newcommand{\fraka}{\mbox{\frakturfont a}}
\newcommand{\db}{\bar{\partial}}
\newcommand{\dbs}{\bar{\partial}^*}
\newcommand{\p}{\partial}

%%%%%%%%%%%%% Bryan's definitions %%%%%%%%%

\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}
\newcommand{\Expect}{\mathbb{E}}
\newcommand{\Var}{\text{Var}}
\newcommand{\Prox}{\text{Prox}}


%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%
\begin{document}
%

\title{VI for probit regression}
\author{Bryan Liu}


\date{\today}

\maketitle


%\setcounter{secnumdepth}{1} 

\section{The generative model}
Let $X\in \reals^{D\times N}$ and $v_0>0$ be fixed parameters. The generative model for our data $t_i$, $i= 1,..., N$ is given by
\begin{align}
w &\sim \mathcal N(0, v_0^2 I_{d\times d})\\
z_n &\sim \mathcal N(\hat z, 1) \quad n = 1, ..., N\\
t_n &= \text{sign}(z_n)\quad n = 1, ..., N
\end{align}

\section{Variational distributions}
We will take a fully factorized distrubtion over $w$ and $\{z_n\}_{n=1}^N$. In particular, 
\begin{align}
q_w(w) &\sim \mathcal N (\hat w, \Sigma^2_w)\\
q_{z_n}(z_n) &\sim \mathcal{N}(\hat z_n, \sigma^2_{z_n})\mathbb I\{\text{sign}(z_n) = t_n\}
\end{align}
That is, $q_{z_n}$ follows a truncated normal distribution; $z_n$ is restricted to $[0,\infty)$ or $(-\infty,  0]$ when $t_n=1$ or $t_n=-1$, respectively. 

\section{Evidence lower bound}
Recall that the ELBO is given by:
\begin{align}
\mathcal L &= E_q[\log p(w,t,z|X)] + H(q) \\
	&=  E_q[\log p(w)] + \Big(\sum_{n=1}^N E_q[\log p(z_n,t_n|w,X)]\Big) - \Big(\sum_{i=1}^n E_q[\log q(z_n)]\Big) - E_q[\log q(w)] 
\end{align} 

We examine each of these terms individually. First, 
\begin{align}
E_q[\log p(w)] &= -\frac{1}{2v_0^2} E_q[w^Tw] + K\\
	&= -\frac{1}{2v_0^2} (\text{Tr}(\Sigma_w) + \hat w^T \hat w) + K
\end{align}

Now we recall some facts about truncated Gaussians. If $z_n\sim \mathcal N(\hat z_n, 1)$, and lies on the interval $[0,\infty)$ (ie when $t_n=1$), then 
\begin{align}
Ez_n = \hat z_n + \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\\
Ez_n^2 = 1 + \hat z_n^2 + \hat z_n \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}
\end{align}
where $\phi$ and $\Phi$ are the normal p.d.f and normal c.d.f., respectively. Conversely, if $z_n$ is conditioned to lie on the interval $(-\infty, 0]$ (ie when $t_n=-1$), then 
\begin{align}
Ez_n = \hat z_n - \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}\\
Ez_n^2 = 1 + \hat z_n^2 - \hat z_n \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}
\end{align}

Hence, if $t_n = 1$, then 
\begin{align}
E_q[\log p(z_n,t_n|w,X)] &= -\frac{1}{2}E_q[(z_n - w^Tx_n)^2]  + K \\
	&=  -\frac{1}{2} E_q[z_n^2] + \hat w^Tx_n E_q[z_n] - \frac{1}{2} x_n^T E[ww^T]x_n + K \\
	&= -\frac{1}{2}\Big(1 + \hat z_n^2  + \hat z_n \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\Big) + \hat w^Tx_n\Big(\hat z_n + \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\Big) - \frac{1}{2} \Big(x_n^T(\Sigma_w + \hat w \hat w^T)x_n\Big) + K 
\end{align}
and if $t_n = -1$ then 
\begin{align}
E_q[\log p(z_n,t_n|w,X)] 
	&=  -\frac{1}{2} E_q[z_n^2] + \hat w^T x_n E_q[z_n] - \frac{1}{2} x_n^T E[ww^T]x_n + K \\
	&= -\frac{1}{2}\Big(1 + \hat z_n^2 - \hat z_n \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}\Big)
	 + \hat w^T x_n\Big(\hat z_n - \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}\Big)  
	  - \frac{1}{2} \Big(x_n^T(\Sigma_w + \hat w \hat w^T)x_n\Big)+ K 
\end{align}

And the entropy for $z_n$ restricted to $[0,\infty)$ is given by 
\begin{align}
H[q(z_n)] &= - E_q[\log q(z_n)] \\
	&= \log\Big(\sqrt{2\pi e} (1- \Phi(-\hat z_n))\Big) - \frac{1}{2}\hat z_n\frac{ \phi(-\hat z_n)}{1 - \Phi(-\hat z_n)} \quad \text{if } t_n = 1
\end{align}
and for $z_n$ restricted to $(-\infty,0]$, 
\begin{align}
H[q(z_n)] &= \log\Big(\sqrt{2\pi e} \Phi(-\hat z_n)\Big) + \frac{1}{2}\hat z_n\frac{ \phi(-\hat z_n)}{\Phi(-\hat z_n)} \quad \text{if } t_n = - 1
\end{align}

Finally, we compute the entropy of $q(w)$, a normal distribution: 
\begin{align}
H(q(w)) &= -E_q[\log q(w) ] \\
	&= \frac{1}{2}\log \big((2\pi e)^D |\Sigma_w|)
\end{align}

%And therefore, we conclude that
%\begin{align}
%\sum_{n=1}^N &E_q[\log p(z_n,t_n|w,X)] + E_q[\log q(z_n) \\
%	&= \sum_{n=1}^N\Bigg(  \mathbb I\{t_n = 1\}\log\Big(\sqrt{2\pi e} (1- \Phi(-%\hat z))\Big) + \mathbb I\{t_n = 0\}\log\Big(\sqrt{2\pi e} \Phi(-\hat z)\Big) + \frac{1}{2}(\hat z)^2\Bigg)
%\end{align}


%\begin{align}
%\log p(w,t,z|X) &= \log p(w) + \sum_{n=1}^N \log p(z_n,t_n|w,X) \\
%	&= -\frac{1}{2v_0} w^Tw + \sum_{n=1}^N -\frac{1}{2}(-z_n - \hat z)^2 %\mathbb I\{t_n = \text{sign}(z_n)\}
%\end{align}

Putting together the pieces, the elbo is given by
\begin{align*}
\mathcal L = 
- \frac{1}{2v_0^2}& (\text{Tr}(\Sigma_w) + \hat w^T \hat w) 
+  \frac{1}{2}\log \big((2\pi e)^D |\Sigma_w|)\\
&+\sum_{n : t_n = 1} -\frac{1}{2}\Big(1 + \hat z_n^2  + \hat z_n \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\Big) + \hat w^Tx_n\Big(\hat z_n + \frac{\phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\Big) + \log\Big(\sqrt{2\pi e} (1- \Phi(-\hat z_n))\Big) - \frac{1}{2}\hat z_n\frac{ \phi(-\hat z_n)}{1 - \Phi(-\hat z_n)}\\
&+\sum_{n : t_n = -1} -\frac{1}{2}\Big(1 + \hat z_n^2 - \hat z_n \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}\Big)
	 + \hat w^T x_n\Big(\hat z_n - \frac{\phi(-\hat z_n)}{\Phi(-\hat z_n)}\Big)  
	  +\log\Big(\sqrt{2\pi e} \Phi(-\hat z_n)\Big) + \frac{1}{2}\hat z_n\frac{ \phi(-\hat z_n)}{\Phi(-\hat z_n)}\\
&+ \sum_{n=1}^N - \frac{1}{2} \Big(x_n^T(\Sigma_w + \hat w \hat w^T)x_n\Big)
\end{align*}



\end{document}